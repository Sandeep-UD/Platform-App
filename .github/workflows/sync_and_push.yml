name: Sync Library Changes Across Folders and Push to Platform-Libs

on:
  push:
    branches:
      - main
    paths:
      - '*/library/**'

  pull_request:
    branches:
      - main
    paths:
      - '*/library/**'

jobs:
  sync-libraries:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Platform-App
        uses: actions/checkout@v3
        with:
          path: platform-app
          fetch-depth: 2

      - name: Checkout Platform-Libs
        uses: actions/checkout@v3
        with:
          repository: Rajesh-playground/Platform-Libs
          token: ${{ secrets.GH_PAT }}
          path: platform-libs

      - name: Compare and Sync Library Files Across Folders (Handle Updates & Deletions)
        run: |
          cd platform-app
          echo "🔁 Detecting and syncing library changes..."
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git fetch
          git checkout main

          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            git diff --name-only HEAD~1 HEAD > ../changed.txt
            git diff --diff-filter=D --name-only HEAD~1 HEAD > ../deleted.txt
            grep -vxFf ../deleted.txt ../changed.txt > ../filtered_changed.txt || true
          else
            echo "⚠️ Not enough commits to perform diff. Skipping sync."
            touch ../filtered_changed.txt
            touch ../deleted.txt
          fi

          echo "📁 Changed files (excluding deleted):"
          cat ../filtered_changed.txt || true
          echo "🗑️ Deleted files:"
          cat ../deleted.txt || true

          updated_files=""

          while read -r file; do
            if [[ "$file" == */library/* ]]; then
              src_folder=$(echo "$file" | cut -d'/' -f1)
              relative_path="${file#*/library/}"
              src_file="$src_folder/library/$relative_path"
              echo "🔍 Checking $relative_path from $src_folder..."
              for target in */; do
                target=${target%/}
                target_file="$target/library/$relative_path"
                if [[ "$target" != "$src_folder" && -f "$target_file" ]]; then
                  if ! cmp -s "$src_file" "$target_file"; then
                    mkdir -p "$(dirname "$target_file")"
                    cp "$src_file" "$target_file"
                    touch "$target_file"
                    echo "✅ Synced $target_file"
                    updated_files="yes"
                  fi
                else
                  echo "⏩ Skipping $target_file (does not exist)"
                fi
              done
            fi
          done < ../filtered_changed.txt

          if [[ "$updated_files" == "yes" ]]; then
            git add .
            if ! git diff --cached --quiet; then
              echo "🔧 Changes detected. Committing..."
              author_name=$(git log -1 --pretty=format:'%an')
              author_email=$(git log -1 --pretty=format:'%ae')
              git commit -m "Synced updated library files across customers (original author: $author_name <$author_email>)"
              git push origin main
            else
              echo "⚠️ Files copied but no actual git diff detected."
            fi
          else
            echo "📭 No updates needed across customers."
          fi

          # Handling deletions: delete files from all customer folders
          while read -r deleted_file; do
            if [[ "$deleted_file" == */library/* ]]; then
              relative_path="${deleted_file#*/library/}"
              echo "🗑️ Deleting $relative_path from Platform-Libs and all customer folders"
              
              # Delete from all customers' folders
              for target in */; do
                target=${target%/}
                target_file="$target/library/$relative_path"
                if [ -f "$target_file" ]; then
                  rm -f "$target_file"
                  echo "Deleted $target_file"
                fi
              done

              # Delete from Platform-Libs as well
              rm -f "../platform-libs/$relative_path"
              echo "Deleted $relative_path from Platform-Libs"
              echo "deleted=true" >> $GITHUB_ENV
            fi
          done < ../deleted.txt

      - name: Push updated or deleted files to Platform-Libs
        run: |
          echo "📤 Syncing changes to Platform-Libs..."
          cd platform-libs
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          cd ../platform-app

          find */library/ -type f | while read file; do
            relative_path="${file#*/library/}"
            mkdir -p "../platform-libs/$(dirname "$relative_path")"
            cp "$file" "../platform-libs/$relative_path"
          done

          cd ../platform-libs
          git add .
          if ! git diff --cached --quiet; then
            echo "✅ Committing synced or deleted files..."
            author_name=$(git log -1 --pretty=format:'%an')
            author_email=$(git log -1 --pretty=format:'%ae')
            git commit -m "Sync updates & deletions from Platform-App (original author: $author_name <$author_email>)"
            git push origin main
          else
            echo "📪 No updates or deletions to push."
          fi
