name: Full Sync Between App and Libs

on:
  push:
    branches:
      - main
    paths:
      - 'Folder*/**'
      - '!**/README.md'

jobs:
  full-sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Platform-App (Main Repo)
        uses: actions/checkout@v3
        with:
          path: platform-app
          fetch-depth: 2

      - name: Checkout Platform-Libs (Base Repo)
        uses: actions/checkout@v3
        with:
          repository: Rajesh-playground/Platform-Libs
          token: ${{ secrets.GH_PAT }}
          path: platform-libs

      - name: Copy base libraries to each folder in Platform-App
        run: |
          echo "üì• Copying libraries from Platform-Libs to Platform-App folders..."
          for folder in platform-app/Folder*/; do
            mkdir -p "$folder/library"
            cp platform-libs/*.py "$folder/library/" 2>/dev/null || true
            cp platform-libs/*.sh "$folder/library/" 2>/dev/null || true
            cp platform-libs/*.java "$folder/library/" 2>/dev/null || true
          done

      - name: Detect and propagate library changes across folders
        run: |
          echo "üîÅ Detecting and propagating updated library files..."
          cd platform-app
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git add .
          git diff --cached --name-only > changes.txt

          if [[ -s changes.txt ]]; then
            echo "üìù Changes detected:"
            cat changes.txt

            while read -r file; do
              folder=$(echo "$file" | cut -d'/' -f1)
              relative_file=$(echo "$file" | cut -d'/' -f3-)

              if [[ "$file" == */library/* ]]; then
                echo "üîÅ Propagating change in $relative_file from $folder..."

                for target in Folder*/; do
                  if [[ "$target" != "$folder/" && -f "$folder/library/$relative_file" ]]; then
                    cp "$folder/library/$relative_file" "$target/library/$relative_file" || echo "‚ö†Ô∏è Conflict in $relative_file ‚Üí skipped"
                  fi
                done
              fi
            done < changes.txt

            git add .
            git commit -m "Synced updated library files across folders"
            git push origin main
          else
            echo "‚úÖ No library changes to sync."
          fi

      - name: Push updated files to Platform-Libs (from Folder1)
        run: |
          echo "üì§ Copying latest library files from Folder1 to Platform-Libs..."
          cp platform-app/Folder1/library/* platform-libs/ 2>/dev/null || true
          cd platform-libs
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git add .
          if ! git diff --cached --quiet; then
            git commit -m "Update shared library files from Platform-App"
            git push origin main
          else
            echo "üì™ No updates to push to Platform-Libs."
          fi
