name: Full Library Sync & Propagation

on:
  push:
    branches:
      - main
    paths:
      - 'Folder*/**'
      - '!**/README.md'

jobs:
  sync-libs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Platform-App (Main Repo)
        uses: actions/checkout@v3
        with:
          path: main-repo
          fetch-depth: 2

      - name: Checkout Platform-Libs (Base Repo)
        uses: actions/checkout@v3
        with:
          repository: Rajesh-playground/Platform-Libs
          token: ${{ secrets.GH_PAT }}
          path: base-repo

      - name: Copy Base Libraries to Each Folder in Main Repo
        run: |
          echo "ðŸ“¥ Copying libraries from Base-Repo to Platform-App folders..."
          for folder in main-repo/Folder*/; do
            mkdir -p "$folder/library"
            cp base-repo/*.py "$folder/library/" 2>/dev/null || true
            cp base-repo/*.sh "$folder/library/" 2>/dev/null || true
            cp base-repo/*.java "$folder/library/" 2>/dev/null || true
          done

      - name: Detect Changed Library Files
        run: |
          cd main-repo
          echo "ðŸ” Detecting changed library files..."
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git fetch
          git checkout main
          git diff --name-only HEAD~1 HEAD > ../changed.txt

      - name: Sync Changed Library Files Across Folders
        run: |
          cd main-repo
          echo "ðŸ”„ Syncing updated library files across folders..."
          updated_files=""

          while read -r file; do
            if [[ "$file" == Folder*/library/* ]]; then
              src_folder=$(echo "$file" | cut -d'/' -f1)
              filename=$(basename "$file")
              src_file="$src_folder/library/$filename"
              echo "ðŸ§ª Syncing $filename from $src_folder..."

              for target in Folder*/; do
                target=${target%/}
                if [[ "$target" != "$src_folder" ]]; then
                  target_file="$target/library/$filename"
                  mkdir -p "$(dirname "$target_file")"
                  if [[ ! -f "$target_file" ]] || ! cmp -s "$src_file" "$target_file"; then
                    cp "$src_file" "$target_file"
                    touch "$target_file"
                    echo "âœ… Synced $target_file"
                    updated_files="yes"
                  fi
                fi
              done
            fi
          done < ../changed.txt

          if [[ "$updated_files" == "yes" ]]; then
            git add .
            if ! git diff --cached --quiet; then
              echo "ðŸ”§ Committing synced changes..."
              git commit -m "Synced updated library files across folders"
              git push origin main
            else
              echo "âš ï¸ No actual changes detected for commit."
            fi
          else
            echo "ðŸ“­ No library updates needed across folders."
          fi

      - name: Push Updated Files to Platform-Libs (Base Repo)
        run: |
          echo "ðŸ“¤ Copying latest library files (from Folder1) to Platform-Libs..."
          cp main-repo/Folder1/library/* base-repo/ 2>/dev/null || true
          cd base-repo
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git add .
          if ! git diff --cached --quiet; then
            git commit -m "Update shared library files from Platform-App"
            git push origin main
          else
            echo "ðŸ“ª No updates to push to Platform-Libs."
          fi
