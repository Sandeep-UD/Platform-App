name: Sync Libraries and Push

on:
  push:
    branches:
      - main
    paths:
      - 'Folder*/**'
      - '!**/README.md'

jobs:
  sync-libraries:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: Platform-App

    steps:
    - name: ⬇️ Checkout Platform-App
      uses: actions/checkout@v3
      with:
        path: Platform-App

    - name: ⬇️ Checkout Platform-Libs
      uses: actions/checkout@v3
      with:
        repository: Rajesh-playground/Platform-Libs
        token: ${{ secrets.GITHUB_TOKEN }}
        path: base-repo

    - name: ⬇️ Copy from Platform-Libs to Platform-App folders...
      run: |
        for folder in Platform-App/Folder*/; do
          mkdir -p "$folder/library"
          cp base-repo/*.py "$folder/library/" 2>/dev/null || true
          cp base-repo/*.sh "$folder/library/" 2>/dev/null || true
          cp base-repo/*.java "$folder/library/" 2>/dev/null || true
        done

    - name: 🔁 Detecting and syncing library changes...
      id: detect
      run: |
        cd Platform-App
        git fetch origin main
        git diff --name-only origin/main > ../changed.txt

        echo "Changed files:"
        cat ../changed.txt

        updated_library="false"
        for folder in Folder*/; do
          libdir="$folder/library"
          for file in $(ls $libdir 2>/dev/null); do
            if grep -q "$libdir/$file" ../changed.txt; then
              echo "📍 Change detected in: $libdir/$file"
              updated_library="true"
            fi
          done
        done

        echo "updated_library=$updated_library" >> $GITHUB_OUTPUT

    - name: 📤 Sync latest library files (from Folder1) to Base-Repo...
      if: steps.detect.outputs.updated_library == 'true'
      run: |
        cp -v Platform-App/Folder1/library/*.py Platform-Libs/ 2>/dev/null || true
        cp -v Platform-App/Folder1/library/*.sh Platform-Libs/ 2>/dev/null || true
        cp -v Platform-App/Folder1/library/*.java Platform-Libs/ 2>/dev/null || true

        cd Platform-Libs
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

        git add .
        if git diff --cached --quiet; then
          echo "📪 No updates to push to Platform-Libs."
        else
          git commit -m "🔄 Sync updated library files from Folder1"
          git push origin main
          echo "✅ Pushed updated library files to Platform-Libs."
        fi
