name: Sync Libraries and Push

on:
  push:
    branches:
      - main
    paths:
      - 'main-repo/**'

jobs:
  sync-libraries:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: main-repo

    steps:
    - name: ⬇️ Checkout Main Repo
      uses: actions/checkout@v3
      with:
        path: main-repo

    - name: ⬇️ Checkout Base Repo
      uses: actions/checkout@v3
      with:
        repository: Rajesh-playground/Base-Repo
        token: ${{ secrets.GITHUB_TOKEN }}
        path: base-repo

    - name: ⬇️ Copy from Base-Repo to Main-Repo folders...
      run: |
        for folder in main-repo/Folder*/; do
          mkdir -p "$folder/library"
          cp base-repo/*.py "$folder/library/" 2>/dev/null || true
          cp base-repo/*.sh "$folder/library/" 2>/dev/null || true
          cp base-repo/*.java "$folder/library/" 2>/dev/null || true
        done

    - name: 🔁 Detecting and syncing library changes...
      id: detect
      run: |
        cd main-repo
        git fetch origin main
        git diff --name-only origin/main > ../changed.txt

        echo "Changed files:"
        cat ../changed.txt

        updated_library="false"
        for folder in Folder*/; do
          libdir="$folder/library"
          for file in $(ls $libdir 2>/dev/null); do
            if grep -q "$libdir/$file" ../changed.txt; then
              echo "📍 Change detected in: $libdir/$file"
              updated_library="true"
            fi
          done
        done

        echo "updated_library=$updated_library" >> $GITHUB_OUTPUT

    - name: 📤 Sync latest library files (from Folder1) to Base-Repo...
      if: steps.detect.outputs.updated_library == 'true'
      run: |
        cp -v main-repo/Folder1/library/*.py base-repo/ 2>/dev/null || true
        cp -v main-repo/Folder1/library/*.sh base-repo/ 2>/dev/null || true
        cp -v main-repo/Folder1/library/*.java base-repo/ 2>/dev/null || true

        cd base-repo
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

        git add .
        if git diff --cached --quiet; then
          echo "📪 No updates to push to Base Repo."
        else
          git commit -m "🔄 Sync updated library files from Folder1"
          git push origin main
          echo "✅ Pushed updated library files to Base Repo."
        fi
